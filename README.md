 [简体中文](README.md) | [English](README.en.md)

# Flow Consumption Tool / 流量消耗工具

连续、按时间窗口、可限速的多线程下行流量消耗脚本，主要用途：
- 在受运营商 / 旁路网关 / 家宽 QoS / 速率自适应影响的场景中，保持一定的下行占用，稳定带宽曲线；
- 维持家庭宽带长期有下行活动，降低上行大流量（如 NAS 远程同步、PT 下载）时被判定为异常的概率；
- 在需要维持运营商 NAT 映射或旁路网关策略（如智能限速、节能休眠等）激活状态时，提供“背景心跳”型数据流；
- 通过主/备用小文件 + 大文件组合下载，平衡频繁连接与持续大流量的需求。

> 请务必在合法、合规、且不违反运营商/平台服务条款的前提下使用。本工具仅供学习与自用网络优化，不建议用于规避计费、恶意消耗或影响他人服务。

---
## 功能特性概览
- 多线程并发：主刷流量线程 (THREADS) + 额外大文件专用线程 (EXTRA_BACKUP_THREAD)
- 时间窗口控制：支持三个每日循环窗口，可跨天运行 (如 13:00~次日01:00)
- 分级 URL 策略：主 URL 优先 -> 备用主 URL -> 备用大文件轮询 (减少单一特征流)
- 失败重试机制：按 RETRY_COUNT / RETRY_DELAY 自动重试
- 限速控制：`curl --limit-rate`（MB/s 粒度）
- 大/小文件混合：失败自动退回至备用大文件，额外线程持续刷大文件
- 统计提示：主与大文件累计分离，跨越 1GB 打印含平均速度提示
- 高精度时间：`date +%s.%N` 计算下载耗时
- systemd 服务化：安装/卸载、自动重启、开机自启
- 交互菜单：测速 / 状态 / 日志跟踪
- 线程安全：`flock` 防并发写
- 容错：时间解析 / curl 异常 / BusyBox 退化处理

---
## 实现架构概要
模块划分（单文件内）：
1. 配置：集中默认值 + 环境覆盖  
2. 菜单：安装、卸载、测速、状态、日志  
3. 时间窗口：解析并滚动下一窗口（支持跨天）  
4. 下载：封装 curl，收集大小+耗时+退出码  
5. 统计：主/大文件累计 + 1GB 分段输出  
6. 线程：主线程优先级策略；大文件专用线程循环刷  
7. 服务化：systemd unit + 环境文件 + 锁/状态文件  
8. 信号：STOP 标志优雅退出  

流程简述：
1. 线程等待进入当前窗口  
2. 主线程尝试 主URL → 备用主 → 备用大文件  
3. 大文件线程循环 `BACKUP_URLS`  
4. 成功后累加字节并判断是否跨段打印  
5. 窗口结束等待下一个；收到 SIGINT/SIGTERM 退出  
6. systemd 异常自动重启  

---
## 适用平台 / 依赖
推荐：Ubuntu / Debian / 其他 systemd + GNU coreutils Linux 发行版。

必须：bash、curl、flock(util-linux)、systemd、GNU date。

---
## 快速开始（前台运行）
```bash
git clone git@github.com:shiranzby/Flow_Consumption_Tool.git
cd Flow_Consumption_Tool
chmod +x continuous_download.sh
# 直接运行进入菜单（前台）
./continuous_download.sh
```

---
## 免责声明

本项目按“自用现状”提供，不对可用性或特定用途适用性做任何保证。使用者需自行承担使用风险与由此可能产生的任何直接或间接后果。
