# Flow Consumption Tool / 流量消耗工具 (v2.1)

简体中文 | [English](README.en.md)

连续、按时间窗口、可限速的多线程下行流量消耗脚本，主要用途：

*   在受运营商 / 旁路网关 / 家宽 QoS / 速率自适应影响的场景中，保持一定的下行占用，稳定带宽曲线；
*   维持家庭宽带长期有下行活动，降低上行大流量（如 NAS 远程同步、PT 下载）时被判定为异常的概率；
*   在需要维持运营商 NAT 映射或旁路网关策略（如智能限速、节能休眠等）激活状态时，提供“背景心跳”型数据流；
*   通过主/备用小文件 + 大文件组合下载，平衡频繁连接与持续大流量的需求。

> **免责声明**：本项目按“自用现状”提供，不对可用性或特定用途适用性做任何保证。请务必在合法、合规、且不违反运营商/平台服务条款的前提下使用。本工具仅供学习与自用网络优化，不建议用于规避计费、恶意消耗或影响他人服务。

---

## 功能特性概览

*   **多线程并发**：主刷流量线程 (THREADS) + 额外大文件专用线程 (EXTRA_BACKUP_THREAD)。
*   **时间窗口控制**：支持三个每日循环窗口，可跨天运行 (如 13:00~次日01:00)。
*   **分级 URL 策略**：主 URL 优先 -> 备用主 URL -> 备用大文件轮询。
*   **失败重试机制**：按 RETRY_COUNT / RETRY_DELAY 自动重试。
*   **总量限速**：LIMIT_MBPS 作为总带宽限制，按活跃线程均分。
*   **日志与统计**：下载日志 + 小时/天级流量统计日志（含简易轮转）。
*   **内存智能保护**：内存高占用时自动缩减主线程并恢复。
*   **实时监控面板**：展示总速度、线程状态、内存与 IP 信息。
*   **双测速能力**：被动 RX 监控 + 主动镜像测速。
*   **服务化**：支持 Systemd 与 OpenWrt Procd 安装/卸载/自启。

## 适用平台 / 依赖

推荐：Ubuntu / Debian / 其他 systemd + GNU coreutils Linux 发行版；OpenWrt (Procd)。

必须：bash, curl, flock(util-linux), systemd 或 procd, GNU date, awk。

## 快速开始

```bash
# 赋予执行权限
chmod +x Flow_Consumption_Tool_v2.1.sh

# 直接运行进入菜单（前台）
./Flow_Consumption_Tool_v2.1.sh
```

### 菜单选项
1.  **安装服务**：自动安装到 systemd 或 OpenWrt procd。
2.  **卸载服务**：停止服务并清理文件。
3.  **刷新配置**：修改线程数/限速并重启服务。
4.  **修改时间窗口**：更新三个时间窗口并重启服务。
5.  **监控实时网速**：被动监控网口 RX。
6.  **启动主动测速**：镜像源主动测速。
7.  **服务状态**：查看服务运行情况。
8.  **查看日志**：实时追踪日志输出。
9.  **实时监控面板**：查看总速度与线程状态。
